<!DOCTYPE html>
<html lang="en">
<head>
  <title>three.js webgl - OBJLoader + MTLLoader with Rotation</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <link type="text/css" rel="stylesheet" href="main.css" />
</head>

<body>
  <div id="info">
    <a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - OBJLoader + MTLLoader with keyboard rotation (A/D)
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "./build/three.module.js",
        "three/addons/": "./jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    let camera, scene, renderer;
    let object; // 模型物件
    let rotateDirection = 0; // -1:逆時針, 1:順時針, 0:不動

    init();

    function init() {
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
      camera.position.z = 5;

      // scene
      scene = new THREE.Scene();

      const ambientLight = new THREE.AmbientLight(0xffffff);
      scene.add(ambientLight);

      const pointLight = new THREE.PointLight(0xffffff, 15);
      camera.add(pointLight);
      scene.add(camera);

      // model
      const onProgress = function (xhr) {
        if (xhr.lengthComputable) {
          const percentComplete = (xhr.loaded / xhr.total) * 100;
          console.log(percentComplete.toFixed(2) + '% downloaded');
        }
      };

      new MTLLoader()
        .setPath('models/obj/male02/')
        .load('ro_PID20201014173104074_20201014173248969.mtl', function (materials) {
          materials.preload();

          new OBJLoader()
            .setMaterials(materials)
            .setPath('models/obj/male02/')
            .load('ro_PID20201014173104074_20201014173248969.obj', function (loadedObject) {
              loadedObject.position.y = -0.95;
              loadedObject.scale.setScalar(0.01);
              scene.add(loadedObject);
              object = loadedObject; // 儲存模型供旋轉使用
            }, onProgress);
        });

      // renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setAnimationLoop(animate);
      document.body.appendChild(renderer.domElement);

      // controls
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.minDistance = 2;
      controls.maxDistance = 5;

      // resize handler
      window.addEventListener('resize', onWindowResize);

      // keyboard control
      window.addEventListener('keydown', (event) => {
        if (event.key === 'd' || event.key === 'D') rotateDirection = 1;
        if (event.key === 'a' || event.key === 'A') rotateDirection = -1;
      });

      window.addEventListener('keyup', (event) => {
        if (event.key === 'd' || event.key === 'D' || event.key === 'a' || event.key === 'A') {
          rotateDirection = 0;
        }
      });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      if (object && rotateDirection !== 0) {
        object.rotation.y += rotateDirection * 0.05;
      }
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
